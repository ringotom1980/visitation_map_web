<?php
/**
 * Path: Public/api/auth/me.php
 * 說明: 回傳目前登入使用者資料（GET /api/auth/me）
 *       - 以 users.organization_id 直接對應縣市中心座標（定位 fallback）
 */

declare(strict_types=1);

require_once __DIR__ . '/../common/bootstrap.php';

$user = current_user();
if (!$user) {
    json_error('尚未登入', 401);
}

// ⭐ 關鍵：釋放 session lock，避免與 list/options 排隊
if (session_status() === PHP_SESSION_ACTIVE) {
    session_write_close();
}

$orgId = (int)($user['organization_id'] ?? 0);

// ✅ organization_id → 中心座標（定位 fallback）
$map = [
    1  => [25.133166060715098, 121.75970829629935], // 基隆市後備指揮部
    2  => [24.97989140950957, 121.46163910979118],  // 新北市後備指揮部
    3  => [25.037529829073833, 121.5107730521227],  // 臺北市後備指揮部
    4  => [24.980935256181116, 121.30582613862603], // 桃園縣後備指揮部
    5  => [24.801802520289954, 120.98609106930098], // 新竹後備指揮部
    6  => [24.5621249904926, 120.81957550848844],   // 苗栗縣後備指揮部
    7  => [24.16738738281195, 120.64912980977255],  // 臺中市後備指揮部
    8  => [23.906629563058143, 120.67788430976687], // 南投縣後備指揮部
    9  => [24.078590751404708, 120.55794612511022], // 彰化縣後備指揮部
    10 => [23.704010623815055, 120.54460235209262], // 雲林縣後備指揮部
    11 => [23.48329564595089, 120.45466476742739],  // 嘉義後備指揮部
    12 => [23.013255253777032, 120.21390824042659], // 臺南市後備指揮部
    13 => [22.672209474905983, 120.33119813857532], // 高雄市後備指揮部
    14 => [22.657999697845177, 120.46803080974007], // 屏東縣後備指揮部
    15 => [24.753333068535852, 121.73824036930003], // 宜蘭縣後備指揮部
    16 => [22.769264191031418, 121.11519696741216], // 臺東縣後備指揮部
    17 => [23.976949651555042, 121.61618005394274], // 花蓮縣後備指揮部
    18 => [23.56835702593132, 119.56627676742914],  // 澎湖縣後備指揮部
    19 => [24.440388473557878, 118.32892322088486], // 金門縣後備服務中心
    20 => [26.160, 119.949],                        // 連江縣後備服務中心
];

// 找不到就用台灣中心保底
list($clat, $clng) = $map[$orgId] ?? [23.700, 120.900];

$orgName = (string)($user['organization_name'] ?? '');

json_success([
    'id'                  => (int)$user['id'],
    'name'                => $user['name'],
    'email'               => $user['email'],
    'phone'               => $user['phone'],
    'title'               => $user['title'],
    'organization_id'     => $orgId,
    'organization_name'   => $orgName,

    // 保留欄位（前端若有用到就不會壞）
    'organization_county' => '',

    // 定位 fallback
    'county_center_lat'   => $clat,
    'county_center_lng'   => $clng,

    'role'                => $user['role'],
    'status'              => $user['status'],
]);
